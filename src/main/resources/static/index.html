<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment Demo (Race Test)</title>
</head>
<body>
<h1>Payment Demo (Race Condition Test)</h1>

<h3>Step 1: Create Payment Session</h3>
<label>Amount:</label>
<input type="number" id="amount" value="100"><br><br>

<label>Currency:</label>
<input type="text" id="currency" value="USD"><br><br>

<button id="createSessionBtn">Create Session</button>

<h3>Step 2: Confirm Payment</h3>
<button id="confirmPaymentBtn">Confirm Payment</button>
<button id="raceTestBtn">Test Race Condition (5 Concurrent Calls)</button>

<h3>Response:</h3>
<pre id="response"></pre>

<script>
    let storedIdempotencyKey = null;

    document.getElementById("createSessionBtn").addEventListener("click", async function () {
        const amount = document.getElementById("amount").value;
        const currency = document.getElementById("currency").value;

        try {
            const response = await fetch("http://localhost:8080/api/payments/session", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    amount: parseFloat(amount),
                    currency: currency
                })
            });

            if (!response.ok) throw new Error("Failed to create session");

            storedIdempotencyKey = await response.text(); // returns plain String

            document.getElementById("response").textContent =
                "Session Created ✅\nIdempotency Key: " + storedIdempotencyKey;

            document.getElementById("confirmPaymentBtn").disabled = false;
            document.getElementById("raceTestBtn").disabled = false;
        } catch (error) {
            document.getElementById("response").textContent = "Error: " + error.message;
        }
    });

    document.getElementById("confirmPaymentBtn").addEventListener("click", async function () {
        const amount = document.getElementById("amount").value;
        const currency = document.getElementById("currency").value;

        try {
            const response = await fetch("http://localhost:8080/api/payments/confirm", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Idempotency-Key": storedIdempotencyKey
                },
                body: JSON.stringify({
                    amount: parseFloat(amount),
                    currency: currency
                })
            });

            if (!response.ok) throw new Error("Failed to confirm payment");

            const data = await response.json();

            document.getElementById("response").textContent =
                "Payment Confirmed ✅\n" +
                "Idempotency Key: " + data.idempotencyKey + "\n" +
                "Result: " + data.result;
        } catch (error) {
            document.getElementById("response").textContent = "Error: " + error.message;
        }
    });

    document.getElementById("raceTestBtn").addEventListener("click", async function () {
        const amount = document.getElementById("amount").value;
        const currency = document.getElementById("currency").value;

        document.getElementById("response").textContent = "Running race test...";

        const requests = Array.from({length: 5}).map(async (_, i) => {
            try {
                const response = await fetch("http://localhost:8080/api/payments/confirm", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Idempotency-Key": storedIdempotencyKey
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        currency: currency
                    })
                });

                if (!response.ok) throw new Error("Failed");
                const data = await response.json();
                return `Request ${i + 1}: ✅ ${data.result}`;
            } catch (err) {
                return `Request ${i + 1}: ❌ ${err.message}`;
            }
        });

        const results = await Promise.all(requests);
        document.getElementById("response").textContent = results.join("\n");
    });
</script>
</body>
</html>
